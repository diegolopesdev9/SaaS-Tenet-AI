ai_result = await ai_service.generate_response(
    message=message_text,
    agency_name=agency.get("nome"),
    conversation_history=history_formatted,
    lead_data=known_lead_data
)
```

---

##  Prompt Corrigido para o Replit Assistant

Cole este prompt no Replit para corrigir o `webhooks.py`:
```
Atualize o arquivo app/routes/webhooks.py para integrar a mem贸ria de conversas.

## Altera莽玫es necess谩rias:

### 1. Adicionar import do ConversationService:
No topo do arquivo, adicione:
from app.services.conversation_service import ConversationService

### 2. Ap贸s a linha "logger.info("Tokens descriptografados")", adicione o bloco de MEMRIA:

        # ============================================
        # MEMRIA DE CONVERSAS
        # ============================================
        
        # Inicializar servi莽o de conversas
        conversation_service = ConversationService(supabase)
        
        # Buscar hist贸rico da conversa
        conversation_data = await conversation_service.get_conversation_history(
            agencia_id=agency_id,
            lead_phone=sender_phone,
            limit_messages=10
        )
        
        # Formatar hist贸rico para o prompt
        history_formatted = conversation_service.format_history_for_prompt(
            conversation_data.get("history", [])
        )
        
        # Obter dados j谩 conhecidos do lead
        known_lead_data = conversation_data.get("lead_data", {})
        
        if conversation_data.get("exists"):
            logger.info(f"Hist贸rico carregado: {conversation_data.get('total_messages', 0)} mensagens")
        else:
            logger.info("Nova conversa iniciada")

### 3. Alterar a chamada do ai_service.generate_response para:

        # Gerar resposta com hist贸rico e contexto
        ai_result = await ai_service.generate_response(
            message=message_text,
            agency_name=agency.get("nome", "Ag锚ncia"),
            agency_prompt=agency.get("prompt_config"),
            conversation_history=history_formatted,
            lead_data=known_lead_data
        )
        
        ai_response = ai_result.get("response", "")
        extracted_data = ai_result.get("extracted_data", {})
        
        logger.info(f"Resposta IA gerada: {ai_response[:100]}...")
        
        if extracted_data:
            logger.info(f"Dados extra铆dos: {extracted_data}")

### 4. Ap贸s "logger.info("Mensagem processada e enviada com sucesso")", adicione:

        # ============================================
        # ATUALIZAO DO HISTRICO
        # ============================================
        
        # Salvar hist贸rico atualizado
        await conversation_service.update_conversation_history(
            agencia_id=agency_id,
            lead_phone=sender_phone,
            user_message=message_text,
            assistant_message=ai_response,
            lead_data=extracted_data if extracted_data else None
        )

### 5. Atualizar o return para incluir mais informa莽玫es:

        return {
            "status": "success",
            "message": "Mensagem processada",
            "lead_phone": sender_phone,
            "conversation_exists": conversation_data.get("exists"),
            "data_extracted": bool(extracted_data)
        }

### 6. Atualizar o health check:

@router.get("/whatsapp/health")
async def webhook_health():
    return {
        "status": "healthy",
        "service": "whatsapp-webhook",
        "memory_enabled": True,
        "qualification_enabled": True
    }

## IMPORTANTE:
- NO altere as outras rotas (rdstation)
- NO remova imports existentes
- Mantenha o tratamento de erros existente